# KronaSteel
Плата управления для вытяжки Krona Steel Jasmin smart Inox glass 5P

История создания проекта:

В наследство от предыдущих хозяев квартиры мне досталась кухонная вытяжка с безвозвратно утерянной платой управления. Видимо отдали в ремонт и потеряли.

После долгих и неудачных попыток найти запчасти было принято решение самостоятельно сделать плату управления, которая бы полностью или частично реализовала функционал оригинальной вытяжки и позволила ей работать.
от оригинальной вытяжки остался 5-скоростной асинхронный двигатель, датчик чистоты воздуха без маркировки (скорее всего MQ-135), блок подсветки в виде двух галогенок и трансформатора и плата с кнопками и семисегментным индикатором. 

Путем поиска в интернете была найдена схема распайки двигателя. Также по найденным фотографиям похожих плат управления (от других моделей) было установлено, что переключение скоростей осуществляется коммутацией отводов обмотки двигателя при помощи 5 электромагнитных реле. Шестое реле используется для включения ламп подсветки.

Функционал вытяжки, согласно Руководству пользователя заключался во включении и отключении двигателя кнопкой ON/OFF, переключении скоростей кнопками + и -, включении - выключении ламп подсветки отдельной кнопкой. Также в оригинальной вытяжке был предусмотрен автоматический режим, в котором скорость двигателя определялась аналоговым сигналом с датчика чистоты воздуха. Еще был реализован режим таймера, позволяющий автоматически отключить вытяжку через 15 минут после включения этого режима.

Анализ платы с кнопками и индикатором показал, что сегменты индикатора запараллелены с кнопками, поэтому для отображения режимов и опроса кнопок используются одни и те же линии. Было решено использовать штатную плату с кнопками, реализовав нужный функционал при помощи микропроцессора.

Для управления вытяжкой было решено использовать микропроцессор STM32F103C8.
6 пинов потребовалось для управления реле (5 скоростей и лампы)
8 пинов - для управления семисегментным индикатором (из них 5 используется также и для кнопок)
1 пин для АЦП

Пины кнопок/индикатора постоянно сконфигурированы на выход. Периодически по прерыванию от таймера TIM3 5 пинов переконфигурируются на вход и происходит опрос кнопок, по результатам которого модиицируются переменные, содержащие состояние режимов:

SPEED - номер скорости двигателя (0 - выключено)
LAMP - состояние ламп подсветки (1 - включено)
AUTO_ON - автоматичекий режим (1- включен, скорость регулируется в зависимости от сигнала с АЦП, 0 - выключен, скорость регулируется кнопками)

При SPEED = 0 работает только кнопка подсветки и кнопка включения мотора. При нажатии кнопки включения мотор начинает работать на 2 скорости. Далее кнопками + и - можно изменять скорость вращения двигателя от 1 до 5. Номер выбранной скорости отображается на семисегментном индикаторе. Повторное нажатие кнопки включения останавливает мотор (SPEED = 0, индикатор не горит).
Для включения автоматического режима следует при работающем двигателе нажать кнопку AUTO, при этом на семисегментном индикаторе отображается символ "А", а скорость регулируется сигналом с АЦП. Кнопки включения, + и - не работают. Для выключения вытяжки надо сначала отключить автоматический режим, а затем нажать кнопку включения.
Кнопка подсветки работает независимо от остальной вытяжки и включает-выключает подсветку в любом режиме.
Функционал таймера пока не реализован.

Из недостатков - использование одних и тех же линий для кнопок и индикатора вызывает паразитное свечение отдельных сегментов в момент нажатия кнопок. Возможно, дополнительная коммутация общих проводов индикатора и кнопок позволит этого избежать. Этот вопрос сейчас в стадии проработки.
